name: ğŸš€ Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'testpypi'
        type: choice
        options:
          - testpypi
          - pypi

env:
  PYTHON_VERSION: "3.11"
  POETRY_VERSION: "1.7.1"

jobs:
  validate-release:
    name: ğŸ” Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-prerelease: ${{ steps.version.outputs.is-prerelease }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ğŸ” Extract version info
        id: version
        run: |
          VERSION=$(poetry version --short)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if [[ $VERSION == *"alpha"* ]] || [[ $VERSION == *"beta"* ]] || [[ $VERSION == *"rc"* ]]; then
            echo "is-prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is-prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Validate version tag
        if: github.event_name == 'release'
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          POETRY_VERSION=${{ steps.version.outputs.version }}
          if [ "$TAG_VERSION" != "$POETRY_VERSION" ]; then
            echo "âŒ Tag version ($TAG_VERSION) doesn't match Poetry version ($POETRY_VERSION)"
            exit 1
          fi
          echo "âœ… Version validation passed"

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: validate-release
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: ğŸ” Install dependencies
        run: |
          poetry install --with dev,test

      - name: ğŸ›¡ï¸ Run security audit
        run: |
          poetry run pip-audit --desc
          
      - name: ğŸ” Run Bandit security scan
        run: |
          poetry run bandit -r aurelis/ -f json -o bandit-report.json
          poetry run bandit -r aurelis/ --severity-level medium

      - name: ğŸ“¤ Upload security reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json

  quality-assurance:
    name: ğŸ§ª Quality Assurance
    runs-on: ubuntu-latest
    needs: validate-release
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: ğŸ” Install dependencies
        run: |
          poetry install --with dev,test

      - name: ğŸ¨ Run code formatting check
        run: |
          poetry run black --check aurelis/ tests/
          poetry run isort --check-only aurelis/ tests/

      - name: ğŸ” Run linting
        run: |
          poetry run flake8 aurelis/ tests/
          poetry run mypy aurelis/

      - name: ğŸ§ª Run tests with coverage
        run: |
          poetry run pytest tests/ \
            --cov=aurelis \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=80 \
            --junitxml=pytest-report.xml

      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: ğŸ“¤ Upload test reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-reports-py${{ matrix.python-version }}
          path: |
            pytest-report.xml
            htmlcov/

  build-package:
    name: ğŸ“¦ Build Package
    runs-on: ubuntu-latest
    needs: [validate-release, security-scan, quality-assurance]
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: ğŸ” Install dependencies
        run: poetry install --only main

      - name: ğŸ—ï¸ Build package
        run: poetry build

      - name: ğŸ” Verify package contents
        run: |
          pip install twine
          twine check dist/*
          
      - name: ğŸ“‹ List package contents
        run: |
          ls -la dist/
          tar -tzf dist/*.tar.gz | head -20

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist-packages
          path: dist/
          retention-days: 30
  publish-testpypi:
    name: ğŸ§ª Publish to TestPyPI
    runs-on: ubuntu-latest
    needs: [build-package]
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'testpypi') ||
      (github.event_name == 'release' && needs.validate-release.outputs.is-prerelease == 'true')
    environment:
      name: testpypi
      url: https://test.pypi.org/project/aurelisai
    steps:
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: dist-packages
          path: dist/

      - name: ğŸš€ Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          skip-existing: true

      - name: âœ… Verify TestPyPI publication
        run: |
          sleep 30  # Wait for package to be available          pip install --index-url https://test.pypi.org/simple/ \
            --extra-index-url https://pypi.org/simple/ \
            aurelisai==${{ needs.validate-release.outputs.version }}
          echo "âœ… Package successfully installed from TestPyPI"
  publish-pypi:
    name: ğŸ¯ Publish to PyPI
    runs-on: ubuntu-latest
    needs: [validate-release, build-package, publish-testpypi]
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'pypi') ||
      (github.event_name == 'release' && needs.validate-release.outputs.is-prerelease == 'false')
    environment:
      name: pypi
      url: https://pypi.org/project/aurelisai
    steps:
      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: dist-packages
          path: dist/

      - name: ğŸ¯ Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: âœ… Verify PyPI publication
        run: |
          sleep 60  # Wait for package to be available
          pip install aurelisai==${{ needs.validate-release.outputs.version }}
          echo "âœ… Package successfully installed from PyPI"

  create-deployment-notification:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [validate-release, publish-pypi]
    if: always()
    steps:
      - name: ğŸ“Š Generate deployment summary
        run: |
          echo "## ğŸš€ Aurelis Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.validate-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** PyPI Production" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ needs.publish-pypi.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'pip install aurelisai==${{ needs.validate-release.outputs.version }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: ğŸ‰ Success notification
        if: needs.publish-pypi.result == 'success'
        run: |
          echo "ğŸ‰ Aurelis v${{ needs.validate-release.outputs.version }} successfully published to PyPI!"
          echo "ğŸ”— Available at: https://pypi.org/project/aurelisai/"

      - name: âŒ Failure notification
        if: needs.publish-pypi.result == 'failure'
        run: |
          echo "âŒ Failed to publish Aurelis v${{ needs.validate-release.outputs.version }} to PyPI"
          echo "ğŸ” Check the workflow logs for details"
          exit 1
